<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Playlist Dashboard (with Login + external users.json)</title>
  <style>
    :root{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;padding:20px;background:#f6f7fb;color:#111}
    .card{max-width:1000px;margin:0 auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 24px rgba(20,20,50,0.08)}
    h1{font-size:22px;margin:0 0 14px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    input[type=text], input[type=password]{flex:1;min-width:220px;padding:10px;border-radius:8px;border:1px solid #ddd}
    input[type=number]{width:110px;padding:10px;border-radius:8px;border:1px solid #ddd}
    .btn{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .btn.danger{background:#dc2626}
    .note{font-size:13px;color:#555;margin-top:6px}
    .preview{margin-top:18px}
    .embed-wrap{position:relative;padding-top:56.25%;background:#000;border-radius:8px;overflow:hidden}
    iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}
    .error{color:#b91c1c;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center}
    label{font-size:14px}
    .small{font-size:13px;color:#666}
    ul.playlist{list-style:none;padding:0;margin:0;max-height:200px;overflow:auto;border:1px solid #ddd;border-radius:8px}
    ul.playlist li{padding:8px 10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    ul.playlist li:last-child{border-bottom:none}
    ul.playlist button{font-size:12px;padding:6px 10px}

    /* login overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:60}
    .login-box{background:#fff;padding:22px;border-radius:12px;max-width:420px;width:92%;box-shadow:0 10px 40px rgba(10,10,30,0.3)}
    .login-box h2{margin:0 0 10px}
    .login-note{font-size:13px;color:#444;margin-bottom:10px}
    .login-actions{display:flex;gap:8px;align-items:center}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <div class="card" id="appCard">
    <h1>YouTube Playlist Dashboard</h1>
    <p class="note">Paste YouTube URLs, build a temporary playlist, and play them inside this page. Playlists are saved per user in your browser.</p>

    <div class="controls">
      <input id="urlInput" type="text" placeholder="https://www.youtube.com/watch?v=..." />
      <input id="startInput" type="number" min="0" placeholder="start (seconds)" />
      <label class="row small"><input id="autoplay" type="checkbox" /> Autoplay</label>
      <button id="addBtn" class="btn">Add to Playlist</button>
    </div>

    <h3>Playlist (<span id="currentUserDisplay">not signed in</span>)</h3>
    <ul id="playlist" class="playlist"></ul>

    <div class="preview">
      <div id="embedArea" class="embed-wrap" style="display:none"></div>
    </div>

    <div style="margin-top:12px">
      <button id="signOutBtn" class="btn secondary" style="display:none">Sign out</button>
      <span class="small" id="saveStatus"></span>
    </div>

    <div id="error" class="error" role="alert" aria-live="polite"></div>
  </div>

  <!-- LOGIN OVERLAY (DEMONSTRATION ONLY) -->
  <div id="loginOverlay" class="overlay" aria-hidden="false">
    <div class="login-box" role="dialog" aria-modal="true">
      <h2>Sign in to use the player</h2>
      <p class="login-note">This demo can load a <strong>users.json</strong> file placed in the same folder as this HTML file. The file should be a JSON object mapping usernames to passwords, e.g. <code>{"alice":"pass","bob":"1234"}</code>.<br><strong>Do not paste real school passwords here.</strong></p>
      <div style="margin-bottom:10px">
        <input id="username" type="text" placeholder="Username" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ddd" />
        <input id="password" type="password" placeholder="Password" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
      </div>
      <div class="login-actions">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="useDemoBtn" class="btn secondary">Use demo account</button>
        <span class="muted">or add a new demo user</span>
      </div>
      <div style="margin-top:10px">
        <input id="newUser" type="text" placeholder="new username" style="width:48%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-right:4%" />
        <input id="newPass" type="password" placeholder="new password" style="width:48%;padding:8px;border-radius:6px;border:1px solid #ddd" />
        <div style="margin-top:8px">
          <button id="addUserBtn" class="btn secondary">Add demo user (local)</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">Security reminder: client-side authentication is only for demos. For real authentication, use a server or your school's Single Sign-On.</p>
    </div>
  </div>

  <script>
    /****************************************************************
     * FEATURES ADDED
     * - Attempt to load users.json from same folder (./users.json)
     * - Merge external users with built-in demo users and localStorage users
     * - Save playlist per signed-in user in localStorage under key 'playlist_<username>'
     * - Auto-save playlist when it changes
     *
     * SECURITY NOTE
     * - This remains a client-side demo. External users.json cannot be written
     *   by this page; it must be placed there by you on the server or local folder
     *   where you serve the files. Browsers may block fetch() for file:// URLs.
     ****************************************************************/

    const defaultUsers = { "demo": "demo123", "student": "studentpass", "guest": "guest" };
    const USERS_KEY = 'demo_users_v1';
    const PLAYLIST_PREFIX = 'playlist_';

    function loadUsersFromLocal(){
      try{ const raw = localStorage.getItem(USERS_KEY); if(raw) return JSON.parse(raw); }catch(e){}
      return null;
    }
    function saveUsersToLocal(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }

    async function loadExternalUsers(){
      try{
        // Attempt to fetch users.json from same folder. If you're opening the HTML via file://, fetch may fail.
        const resp = await fetch('./users.json?cachebust=' + Date.now());
        if(!resp.ok) throw new Error('no external users.json');
        const data = await resp.json();
        if(typeof data === 'object' && data !== null) return data;
      }catch(e){/* ignore */}
      return null;
    }

    async function buildUsers(){
      const users = Object.assign({}, defaultUsers);
      const external = await loadExternalUsers();
      if(external){ Object.keys(external).forEach(k=>{ users[k] = external[k]; }); }
      const local = loadUsersFromLocal();
      if(local){ Object.keys(local).forEach(k=>{ users[k] = local[k]; }); }
      return users;
    }

    // ----- YouTube helper functions -----
    async function fetchTitle(videoId){
      try{
        const resp = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        if(!resp.ok) return videoId;
        const data = await resp.json();
        return data.title || videoId;
      }catch(e){ return videoId; }
    }

    function getYouTubeID(url){
      if(!url || typeof url !== 'string') return null;
      url = url.trim();
      if(/^[A-Za-z0-9_-]{11}$/.test(url)) return url;
      try{
        const u = new URL(url);
        if(u.hostname === 'youtu.be') return u.pathname.slice(1) || null;
        if(u.hostname.includes('youtube.com')){
          const v = u.searchParams.get('v'); if(v) return v;
          const parts = u.pathname.split('/').filter(Boolean);
          const embedIndex = parts.indexOf('embed'); if(embedIndex !== -1 && parts[embedIndex+1]) return parts[embedIndex+1];
          const maybe = parts[parts.length-1]; if(maybe && /^[A-Za-z0-9_-]{11}$/.test(maybe)) return maybe;
        }
      }catch(e){}
      const regex = /(?:v=|\/embed\/|youtu\.be\/)([A-Za-z0-9_-]{11})/;
      const m = url.match(regex);
      return m ? m[1] : null;
    }

    // ----- DOM elements -----
    const urlInput = document.getElementById('urlInput');
    const startInput = document.getElementById('startInput');
    const autoplayCheckbox = document.getElementById('autoplay');
    const addBtn = document.getElementById('addBtn');
    const embedArea = document.getElementById('embedArea');
    const errorEl = document.getElementById('error');
    const playlistEl = document.getElementById('playlist');
    const loginOverlay = document.getElementById('loginOverlay');
    const loginBtn = document.getElementById('loginBtn');
    const useDemoBtn = document.getElementById('useDemoBtn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const addUserBtn = document.getElementById('addUserBtn');
    const newUserInput = document.getElementById('newUser');
    const newPassInput = document.getElementById('newPass');
    const currentUserDisplay = document.getElementById('currentUserDisplay');
    const signOutBtn = document.getElementById('signOutBtn');
    const saveStatus = document.getElementById('saveStatus');

    let users = {};
    let playlist = [];
    let currentUser = null;
    let autosaveTimer = null;

    function showError(msg){ errorEl.textContent = msg; }
    function clearError(){ errorEl.textContent = ''; }

    function buildEmbedUrl(id, startSeconds, autoplay){
      let url = 'https://www.youtube.com/embed/' + encodeURIComponent(id);
      const params = new URLSearchParams();
      if(startSeconds && Number(startSeconds) > 0) params.set('start', Math.max(0, Math.floor(Number(startSeconds))));
      if(autoplay) params.set('autoplay', '1');
      params.set('enablejsapi','1');
      const qs = params.toString(); if(qs) url += '?' + qs;
      return url;
    }

    async function renderPlaylist(){
      playlistEl.innerHTML = '';
      for(let i=0;i<playlist.length;i++){
        const item = playlist[i];
        const li = document.createElement('li');
        const title = item.title || await fetchTitle(item.id);
        item.title = title;
        const titleSpan = document.createElement('span');
        titleSpan.textContent = title;
        li.appendChild(titleSpan);

        const btns = document.createElement('div');
        const playBtn = document.createElement('button');
        playBtn.textContent = 'Play'; playBtn.className = 'btn secondary';
        playBtn.addEventListener('click', ()=> playVideo(item));

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Remove'; delBtn.className = 'btn danger';
        delBtn.addEventListener('click', ()=>{ playlist.splice(i,1); renderPlaylist(); savePlaylistForCurrentUser(); });

        btns.appendChild(playBtn); btns.appendChild(delBtn);
        li.appendChild(btns);
        playlistEl.appendChild(li);
      }
      updateSaveStatus('');
    }

    function playVideo(item){
      embedArea.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = buildEmbedUrl(item.id, item.start, item.autoplay);
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.allowFullscreen = true;
      embedArea.appendChild(iframe);
      embedArea.style.display = 'block';
    }

    addBtn.addEventListener('click', async ()=>{
      clearError();
      const id = getYouTubeID(urlInput.value);
      if(!id){ showError('Invalid YouTube URL or ID'); return; }
      const title = await fetchTitle(id);
      const item = { id, start: startInput.value, autoplay: autoplayCheckbox.checked, title };
      playlist.push(item);
      renderPlaylist();
      urlInput.value = ''; startInput.value = ''; autoplayCheckbox.checked = false;
      savePlaylistForCurrentUser();
    });

    // --- save/load playlist per user ---
    function playlistKeyForUser(u){ return PLAYLIST_PREFIX + encodeURIComponent(u); }
    function savePlaylistForCurrentUser(){
      if(!currentUser) return;
      try{
        localStorage.setItem(playlistKeyForUser(currentUser), JSON.stringify(playlist));
        updateSaveStatus('Saved');
        // clear status after short time
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(()=> updateSaveStatus(''), 1500);
      }catch(e){ updateSaveStatus('Save failed'); }
    }
    function loadPlaylistForUser(u){
      try{
        const raw = localStorage.getItem(playlistKeyForUser(u));
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return [];
    }

    function updateSaveStatus(text){ saveStatus.textContent = text; }

    // --- login flow ---
    function requireLogin(){ loginOverlay.style.display = 'flex'; }
    function showAppForUser(u){
      currentUser = u; loginOverlay.style.display = 'none'; currentUserDisplay.textContent = u; signOutBtn.style.display = 'inline-block';
      playlist = loadPlaylistForUser(u) || [];
      renderPlaylist();
    }

    function authenticate(user, pass){ return users[user] && users[user] === pass; }

    loginBtn.addEventListener('click', ()=>{
      const u = usernameInput.value.trim(); const p = passwordInput.value;
      if(!u || !p){ alert('Enter username and password (demo).'); return; }
      if(authenticate(u,p)) showAppForUser(u); else alert('Incorrect credentials (demo only).');
    });

    useDemoBtn.addEventListener('click', ()=>{
      usernameInput.value = 'demo'; passwordInput.value = users['demo'] || defaultUsers['demo']; loginBtn.click();
    });

    addUserBtn.addEventListener('click', ()=>{
      const nu = newUserInput.value.trim(); const np = newPassInput.value;
      if(!nu || !np){ alert('Enter a username and password to add a local demo user.'); return; }
      users[nu] = np; // update in-memory
      // save local users separately
      let local = loadUsersFromLocal(); if(!local) local = {};
      local[nu] = np; saveUsersToLocal(local);
      alert('Added local demo user: ' + nu);
      newUserInput.value = ''; newPassInput.value = '';
    });

    signOutBtn.addEventListener('click', ()=>{
      currentUser = null; playlist = []; renderPlaylist(); loginOverlay.style.display = 'flex'; signOutBtn.style.display = 'none'; currentUserDisplay.textContent = 'not signed in'; updateSaveStatus('');
    });

    // initialize users and show login
    (async function init(){
      users = await buildUsers();
      // if an external users.json was loaded, users will contain them
      requireLogin();
    })();

  </script>
</body>
</html>
